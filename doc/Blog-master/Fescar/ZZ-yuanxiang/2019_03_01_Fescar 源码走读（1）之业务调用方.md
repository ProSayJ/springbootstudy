title: Fescar Ê∫êÁ†ÅËµ∞ËØªÔºà1Ôºâ‰πã‰∏öÂä°Ë∞ÉÁî®Êñπ
date: 2019-03-01
tags:
categories: Fescar
permalink: Fescar/yuanxiang/1-Business-Invoker
author: yuanxiang
from_url: https://zhuanlan.zhihu.com/p/54659540
wechat_url:

-------

ÊëòË¶Å: ÂéüÂàõÂá∫Â§Ñ https://zhuanlan.zhihu.com/p/54659540 „Äåyuanxiang„ÄçÊ¨¢ËøéËΩ¨ËΩΩÔºå‰øùÁïôÊëòË¶ÅÔºåË∞¢Ë∞¢ÔºÅ


-------

![](http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg)

> üôÇüôÇüôÇÂÖ≥Ê≥®**ÂæÆ‰ø°ÂÖ¨‰ºóÂè∑Ôºö„ÄêËäãÈÅìÊ∫êÁ†Å„Äë**ÊúâÁ¶èÂà©Ôºö
> 1. RocketMQ / MyCAT / Sharding-JDBC **ÊâÄÊúâ**Ê∫êÁ†ÅÂàÜÊûêÊñáÁ´†ÂàóË°®
> 2. RocketMQ / MyCAT / Sharding-JDBC **‰∏≠ÊñáÊ≥®ÈáäÊ∫êÁ†Å GitHub Âú∞ÂùÄ**
> 3. ÊÇ®ÂØπ‰∫éÊ∫êÁ†ÅÁöÑÁñëÈóÆÊØèÊù°ÁïôË®Ä**ÈÉΩ**Â∞ÜÂæóÂà∞**ËÆ§Áúü**ÂõûÂ§ç„ÄÇ**ÁîöËá≥‰∏çÁü•ÈÅìÂ¶Ç‰ΩïËØªÊ∫êÁ†Å‰πüÂèØ‰ª•ËØ∑ÊïôÂô¢**„ÄÇ
> 4. **Êñ∞ÁöÑ**Ê∫êÁ†ÅËß£ÊûêÊñáÁ´†**ÂÆûÊó∂**Êî∂Âà∞ÈÄöÁü•„ÄÇ**ÊØèÂë®Êõ¥Êñ∞‰∏ÄÁØáÂ∑¶Âè≥**„ÄÇ
> 5. **ËÆ§ÁúüÁöÑ**Ê∫êÁ†Å‰∫§ÊµÅÂæÆ‰ø°Áæ§„ÄÇ

-------


ÂÖàÁÆÄÂçïËµ∞‰∏Ä‰∏ã‰∏ªÊµÅÁ®ã(‰ªÖÂÅöÂèÇËÄÉÔºåÂ¶ÇÊúâÈîôËØØÂêéÁª≠Êõ¥Ê≠£)



ÂÖà‰ªéGlobalTransactionalÁúãËµ∑ÔºåËøô‰∏™Ê†áÁ≠æÊòØÂÖ®Â±Ä‰∫ãÂä°ÂèëËµ∑ÁöÑÊ†áÂøóÔºåÂÆÉÊòØÈÄöËøáGlobalTransactionScannerÊñπÊ≥ïÂú®ÂàùÂßãÂåñÂØπË±°‰πãÂâçËá™Âä®Êâ´ÊèèGlobalTransactionalÊ†áÁ≠æÔºåÂàõÂª∫Áõ∏Â∫îÊñπÊ≥ïÊâÄÂú®Á±ªÁöÑ‰ª£ÁêÜÁ±ªÔºåintecepterÊòØGlobalTransactionalInterceptor

```Java
    public Object invoke(final MethodInvocation methodInvocation) throws Throwable {
        final GlobalTransactional anno = getAnnotation(methodInvocation.getMethod());
        if (anno != null) {
            try {
                return transactionalTemplate.execute(new TransactionalExecutor() {
                    @Override
                    public Object execute() throws Throwable {
                        return methodInvocation.proceed();
                    }

                    @Override
                    public int timeout() {
                        return anno.timeoutMills();
                    }

                    @Override
                    public String name() {
                        if (anno.name() != null) {
                            return anno.name();
                        }
                        return formatMethod(methodInvocation.getMethod());
                    }
                });
            } catch (TransactionalExecutor.ExecutionException e) {
                TransactionalExecutor.Code code = e.getCode();
                switch (code) {
                    case RollbackDone:
                        throw e.getOriginalException();
                    case BeginFailure:
                        failureHandler.onBeginFailure(e.getTransaction(), e.getCause());
                        throw e.getCause();
                    case CommitFailure:
                        failureHandler.onCommitFailure(e.getTransaction(), e.getCause());
                        throw e.getCause();
                    case RollbackFailure:
                        failureHandler.onRollbackFailure(e.getTransaction(), e.getCause());
                        throw e.getCause();
                    default:
                        throw new ShouldNeverHappenException("Unknown TransactionalExecutor.Code: " + code);

                }
            }

        }
        return methodInvocation.proceed();
    }
```

ÂÖ∑‰ΩìÁöÑ‰∫ãÂä°Ë∞ÉÁî®Ê®°ÊùøÂú®**transactionalTemplate‰∏≠Ôºö**

```Java
    public Object execute(TransactionalExecutor business) throws TransactionalExecutor.ExecutionException {

        // 1. get or create a transaction
        GlobalTransaction tx = GlobalTransactionContext.getCurrentOrCreate();

        // 2. begin transaction
        try {
            tx.begin(business.timeout(), business.name());

        } catch (TransactionException txe) {
            throw new TransactionalExecutor.ExecutionException(tx, txe,
                TransactionalExecutor.Code.BeginFailure);

        }

        Object rs = null;
        try {

            // Do Your Business
            rs = business.execute();

        } catch (Throwable ex) {

            // 3. any business exception, rollback.
            try {
                tx.rollback();

                // 3.1 Successfully rolled back
                throw new TransactionalExecutor.ExecutionException(tx, TransactionalExecutor.Code.RollbackDone, ex);

            } catch (TransactionException txe) {
                // 3.2 Failed to rollback
                throw new TransactionalExecutor.ExecutionException(tx, txe,
                    TransactionalExecutor.Code.RollbackFailure, ex);

            }

        }

        // 4. everything is fine, commit.
        try {
            tx.commit();

        } catch (TransactionException txe) {
            // 4.1 Failed to commit
            throw new TransactionalExecutor.ExecutionException(tx, txe,
                TransactionalExecutor.Code.CommitFailure);

        }
        return rs;
    }
```

ËøôÈáåÁöÑtx.begin, tx.commitÁ≠âÈÉΩÊòØrpcËØ∑Ê±ÇÔºå‰ºöÈÄöÁü•tmÊñπÂΩìÂâçË¶ÅÂèëÁîüÁöÑÂä®‰ΩúÔºåÊúâtmÊù•ÁÆ°ÁêÜ‰∫ãÂä°ÁöÑÁä∂ÊÄÅÔºåÁÑ∂ÂêéÂÜçÈÄöÁü•rmÊù•ÂÖ∑‰ΩìÊâßË°åÁõ∏Â∫îÁöÑÂä®‰Ωú



ÂÖ∑‰ΩìÁúã‰∏ãtx.commitËøáÁ®ãÔºö

```text
    public void commit() throws TransactionException {
        check();
        RootContext.unbind();
        if (role == GlobalTransactionRole.Participant) {
            // Participant has no responsibility of committing
            return;
        }
        status = transactionManager.commit(xid);

    }
```

‰ºöÁßªÈô§‰øùÂ≠òÂú®threadlocalÈáåÁöÑÂÖ®Â±Ä‰∫ãÂä°id, ÂØπ‰∫éÂàÜÊîØ‰∫ãÂä°‰∏çÈúÄË¶ÅÂëäËØâtm‰∫ãÂä°Âä®‰ΩúÔºåÂè™Êúâ‰∫ãÂä°ÂèëËµ∑ËÄÖÊâç‰ºöÈÄöÁü•tm.

DefaultTransactionManagerÈáåÁöÑcommitÊñπÊ≥ïÔºö

```text
    public GlobalStatus commit(String xid) throws TransactionException {
        long txId = XID.getTransactionId(xid);
        GlobalCommitRequest globalCommit = new GlobalCommitRequest();
        globalCommit.setTransactionId(txId);
        GlobalCommitResponse response = (GlobalCommitResponse) syncCall(globalCommit);
        return response.getGlobalStatus();
    }
```

begin,commit,rollbackÊñπÊ≥ïÈÉΩ‰ºöË∞ÉÁî®syncCallËÄå‰∏îrequestÈÉΩÊòØ‰∏ÄÊ†∑ÁöÑÂèÇÊï∞



ÁõÆÂâçÂè™ÊîØÊåÅATÊ®°Âºè

GlobalTransactionScanner

```Java
    private void initClient() {
        if (LOGGER.isInfoEnabled()) {
            LOGGER.info("Initializing Global Transaction Clients ... ");
        }
        if (StringUtils.isEmpty(applicationId) || StringUtils.isEmpty(txServiceGroup)) {
            throw new IllegalArgumentException(
                "applicationId: " + applicationId + ", txServiceGroup: " + txServiceGroup);
        }
        TMClient.init(applicationId, txServiceGroup);
        if (LOGGER.isInfoEnabled()) {
            LOGGER.info(
                "Transaction Manager Client is initialized. applicationId[" + applicationId + "] txServiceGroup["
                    + txServiceGroup + "]");
        }
        if ((AT_MODE & mode) > 0) {
            RMClientAT.init(applicationId, txServiceGroup);
            if (LOGGER.isInfoEnabled()) {
                LOGGER.info(
                    "Resource Manager for AT Client is initialized. applicationId[" + applicationId
                        + "] txServiceGroup["
                        + txServiceGroup + "]");
            }
        }
        if ((MT_MODE & mode) > 0) {
            throw new NotSupportYetException();
        }
        if (LOGGER.isInfoEnabled()) {
            LOGGER.info("Global Transaction Clients are initialized. ");
        }
    }
```



dubboÈÄöËøáTransactionPropagationFilter‰º†ËæìxidÁªôÂàÜÊîØÊúçÂä°:

```java
    public Result invoke(Invoker<?> invoker, Invocation invocation) throws RpcException {
        String xid = RootContext.getXID();
        String rpcXid = RpcContext.getContext().getAttachment(RootContext.KEY_XID);
        if (LOGGER.isDebugEnabled()) {
            LOGGER.debug("xid in RootContext[" + xid + "] xid in RpcContext[" + rpcXid + "]");
        }
        boolean bind = false;
        if (xid != null) {
//Ê∂àË¥πÊñπ
            RpcContext.getContext().setAttachment(RootContext.KEY_XID, xid);
        } else {
//ÊúçÂä°Êèê‰æõËÄÖÊñπ
            if (rpcXid != null) {
                RootContext.bind(rpcXid);
                bind = true;
                if (LOGGER.isDebugEnabled()) {
                    LOGGER.debug("bind[" + rpcXid + "] to RootContext");
                }
            }
        }
        try {
            return invoker.invoke(invocation);

        } finally {
            if (bind) {
                String unbindXid = RootContext.unbind();
                if (LOGGER.isDebugEnabled()) {
                    LOGGER.debug("unbind[" + unbindXid + "] from RootContext");
                }
                if (!rpcXid.equalsIgnoreCase(unbindXid)) {
                    LOGGER.warn("xid in change during RPC from " + rpcXid + " to " + unbindXid);
                    if (unbindXid != null) {
                        RootContext.bind(unbindXid);
                        LOGGER.warn("bind [" + unbindXid + "] back to RootContext");
                    }
                }
            }
        }
    }
```

